<style>
textarea {
	width: 100%;
}
.error {
	color: red;
}
#buffer span {
	text-decoration: underline;
	padding: 0 0.2em;
}
</style>
<textarea id="result" rows="10" cols="60" disabled>Loading ...</textarea>
<ol id="sel"></ol>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
<script src="./jszhuying.js"></script>
<script src="./mobi.js"></script>
<script>

function print () {
	console.log.apply(this, arguments);
}

var jszhuying = JSZhuYing(
	{
//		disableIndexedDB: true,
		progress: function (msg) {
			jQuery('textarea').val(msg);
		},
		ready: function () {
			jQuery('textarea').attr('disabled',false).val('Ready: ').focus();
		}
	}
),
mobi = JSZhuYing.Mobi(
  {
    sendChoices: function (choices) {
      var $sel = jQuery('#sel').empty();
      choices.forEach(
        function (choice) {
          $sel.append($('<li class="' + choice[1] + '" />').text(choice[0]));
        }
      );
    },
    sendString: function (str) {
      jQuery('textarea')[0].value += str;
    },
    sendKey: function (code) {
      var textarea = jQuery('textarea')[0];
      if (code === 8) { // simulate backspace
        textarea.value = textarea.value.substr(0, textarea.value.length - 1);
      } else {
        textarea.value += String.fromCharCode(code);
      }
    }
  }
),
layout = {
	",":"ㄝ",
	"-":"ㄦ",
	".":"ㄡ",
	"/":"ㄥ",
	"0":"ㄢ",
	"1":"ㄅ",
	"2":"ㄉ",
	"3":"ˇ",
	"4":"ˋ",
	"5":"ㄓ",
	"6":"ˊ",
	"7":"˙",
	"8":"ㄚ",
	"9":"ㄞ",
	";":"ㄤ",
	"a":"ㄇ",
	"b":"ㄖ",
	"c":"ㄏ",
	"d":"ㄎ",
	"e":"ㄍ",
	"f":"ㄑ",
	"g":"ㄕ",
	"h":"ㄘ",
	"i":"ㄛ",
	"j":"ㄨ",
	"k":"ㄜ",
	"l":"ㄠ",
	"m":"ㄩ",
	"n":"ㄙ",
	"o":"ㄟ",
	"p":"ㄣ",
	"q":"ㄆ",
	"r":"ㄐ",
	"s":"ㄋ",
	"t":"ㄔ",
	"u":"ㄧ",
	"v":"ㄒ",
	"w":"ㄊ",
	"x":"ㄌ",
	"y":"ㄗ",
	"z":"ㄈ",
	" ":" "
};

jQuery(function($) {
  $('#sel').on(
    'click',
    'li.whole',
    function () {
      mobi.select(
        $(this).text(),
        'whole'
      );
      $('textarea').focus();
    }
  ).on(
    'click',
    'li.term',
    function () {
      mobi.select(
        $(this).text(),
        'term'
      );
      $('textarea').focus();
    }
  );

	$('textarea').on(
		'keypress',
		function (ev) {
			if (ev.altKey || ev.metaKey || ev.shiftKey) return;

  		ev.preventDefault();

      var code = ev.keyCode || ev.charCode,
      chr = String.fromCharCode(code);

      if (chr in layout) code = layout[chr].charCodeAt(0);

      mobi.keypress(code);
		}
	);
});
</script>
